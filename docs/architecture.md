# Архитектура платформы B2B WebWhatsApp - Jivo

## 1. Компоненты системы

- **Backend (`backend/`)** — NestJS + Prisma. Отвечает за аутентификацию, многотенантность, REST API, работу с БД и постановку задач в очередь.
- **Коннекторы (`connectors/`)** — воркеры для обработки очередей. На данный момент реализован `wa-gateway`, в будущем будут добавлены адаптеры Jivo и медиапрокси.
- **Фронтенд (`frontend/`)** — Next.js (App Router), административный интерфейс для платформенных и tenant-администраторов.
- **Очередь сообщений** — RabbitMQ (в docker-compose) для буферизации событий между сервисами и асинхронной обработки.
- **Хранилища**:
  - PostgreSQL — основная база данных (тенанты, пользователи, сообщения, медиа?метаданные, логи).
  - Redis (планируется) — кеши и rate limit.
  - Объектное хранилище S3/MinIO — временное хранение медиаданных и файлов сессий.
- **Инфраструктура** — Docker/Docker Compose для локального окружения, GitHub Actions для CI, в перспективе Helm/Terraform для облачных развёртываний.

## 2. ER-схема (сводка)

```
+-----------+      +--------------+      +---------------------+
| tenants   | 1  n | users        | n 1  | roles               |
+-----------+      +--------------+      +---------------------+
     | 1                                 ^
     |                                   |
     |                                   |
     |      +----------------------+     |
     +----< | user_role_assignments| >----+
            +----------------------+

+-----------+      +-------------------+      +---------------------+
| tenants   | 1  n | jivo_channels     | 1 1  | channel_credentials |
+-----------+      +-------------------+      +---------------------+
     |
     |      +--------------------+
     +----< | whatsapp_accounts  |
            +--------------------+
                  |
                  | 1
                  v
            +------------------+
            | wa_sessions      |
            +------------------+

+----------------+      +------------------+      +---------------------+
| conversations  | 1  n | messages         | 1 1  | message_media       |
+----------------+      +------------------+      +---------------------+
        ^                         |
        |                         | 1
        |                         v
        |                 +---------------------+
        |                 | message_audit_logs |
        |                 +---------------------+
        |
        +---------------------------+
                                    |
                              +--------------------+
                              | delivery_attempts  |
                              +--------------------+
```

### Ключевые таблицы

- **tenants** — параметры тенанта, лимиты слотов WhatsApp, статусы.
- **users / roles / user_role_assignments** — пользователи, роли, связи между ними (поддержка платформенных и tenant-ролей).
- **jivo_channels / channel_credentials** — настройки каналов Jivo и связанные секреты (вебхуки, токены).
- **whatsapp_accounts / wa_sessions** — состояние подключённых WhatsApp-номеров и их сессий.
- **conversations / messages** — связь каналов и аккаунтов, история сообщений с payload и статусами доставки.
- **message_media** — метаданные медиаданных (ключ в S3, срок жизни).
- **jivo_webhook_events** — сырые события из Jivo, статус обработки, заголовки и полезная нагрузка.
- **delivery_attempts / message_audit_logs** — попытки доставки и пошаговые события обработки.
- **tenant_weekly_metrics / maintenance_run_logs** — агрегированные метрики и архив запусков регламентных задач.

## 3. Потоки обработки

1. **Jivo > WhatsApp**
   - Jivo отправляет webhook > backend валидирует payload, сохраняет `messages`, `message_audit_logs` > сообщение ставится в очередь `wa-gateway` > коннектор преобразует событие и отправляет в WhatsApp > фиксируются `delivery_attempts`.
2. **WhatsApp > Jivo**
   - Коннектор улавливает событие из WhatsApp > нормализует и публикует в очередь > backend читает событие, сохраняет `messages`, отправляет в Jivo Chat API, обновляет статусы доставки.
3. **Медиа**
   - При передаче файлов backend/коннектор загружает объект в бакет `media-temp`, добавляет запись в `message_media` и выставляет `expires_at` через 24 часа.
4. **Регламентные задачи**
   - CronJob `media-cleanup` чистит устаревшие файлы и записи.
   - `log-retention` агрегирует статистику и чистит логи старше 7 дней.
   - `session-rotation` обслуживает устаревшие WA-сессии.

## 4. Индексация и ретеншн

- Индексы по `messages (tenant_id, conversation_id, sent_at)` и `correlation_id` ускоряют выборку истории.
- `message_media (expires_at)` и `message_audit_logs (tenant_id, created_at)` позволяют эффективно удалять устаревшие данные.
- Политики хранения: текстовые сообщения без ограничения, медиаданные 24 часа, логи 7 дней, агрегаты 90 дней.

## 5. Безопасность данных

- Чувствительные данные (`channel_credentials`, `session_data_ref`) шифруются на уровне приложения и/или S3.
- Секреты хранятся в внешнем секрет-менеджере (Vault/ExternalSecrets).
- Для API вводится разграничение доступа по ролям и проверка `tenant_id`, планируется внедрение Row Level Security.
- Вебхуки Jivo подписываются секретом, IP-адреса в allowlist, для исходящих вызовов предусмотрен retry + backoff.

## 6. Текущие задачи

- Добавить контроллер вебхуков Jivo и публикацию событий в очередь.
- Реализовать сопоставление WA-событий с `conversations` и enrich-пайплайн.
- Доработать метрики и алертинг (Prometheus/Grafana) и подготовить Helm chart.
