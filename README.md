# Платформа B2B WebWhatsApp и Jivo

Репозиторий содержит многотенантную платформу, объединяющую WebWhatsApp и Jivo Chat API. Платформа предоставляет изолированные кабинеты для настройки каналов и маршрутизации сообщений между системами.

## Запланированные возможности

- Панель платформенного администратора и кабинеты тенантов с детализированным RBAC.
- Подключение нескольких WhatsApp-коннекторов на тенант с контролем квот и мониторингом сессий.
- Двунаправленная интеграция с Jivo Chat API (вебхуки, исходящий REST, клавиатуры, работа с медиа).
- Долгосрочное хранение текстов, 24-часовой ретеншн медиа, аудит доставок и недельные метрики.
- Автоматические задачи очистки, централизованное логирование и наблюдаемость через Prometheus/Loki.

## Структура репозитория

```
backend/           # NestJS + Prisma API сервис
frontend/          # Next.js административный интерфейс (заготовка)
connectors/        # Воркеры (wa-gateway и будущие адаптеры)
infrastructure/    # Docker Compose, IaC-артефакты, CI/CD файлы
docs/              # Документация по архитектуре и эксплуатации
```

## Локальная разработка

1. Установите Node.js >= 20 и pnpm >= 8.15.4 (на Windows без прав администратора: `npm install pnpm@8.15.4 --global --prefix %LOCALAPPDATA%\pnpm`).
2. Выполните `pnpm install` в корне репозитория.
3. Скопируйте `backend/.env.example` в `backend/.env` и обновите параметры подключения к БД при необходимости.
4. Примените миграции командой `pnpm --filter @server-wa-b2b/backend prisma:migrate`.
5. Запустите API: `pnpm --filter @server-wa-b2b/backend start:dev` и откройте `http://localhost:3000/api/health`.
6. Опционально выполните сиды: `pnpm --filter @server-wa-b2b/backend prisma:seed` (создаёт платформенного администратора и базовые роли).

## Docker Compose демо-стенд

```
cd infrastructure
pnpm dlx dotenv-vault@latest  # опционально для управления env-файлами
docker compose up --build
```

Поднимается PostgreSQL, RabbitMQ, NestJS-бэкенд (`http://localhost:3000`), воркер wa-gateway и фронтенд Next.js (`http://localhost:3001`). Переменные окружения настраиваются в `infrastructure/docker-compose.yml`.

## CI/CD

- `.github/workflows/ci.yml` выполняет lint/test/build для всех пакетов.
- Следующие итерации добавят пайплайны для публикации Docker-образов и деплоя Helm-чартов в Kubernetes.

## Документация

- `docs/architecture.md` — компоненты системы и ER-модель.
- `docs/storage-and-lifecycle.md` — объекстное хранилище и политики жизненного цикла.
- `docs/cleanup-jobs.md` — крон-задачи по ретеншну медиаданных и логов.

## Дорожная карта

1. Завершить потоки аутентификации, настроить роли и CRUD для тенантов и каналов.
2. Реализовать адаптер вебхуков Jivo и клиент исходящих событий с ретраями.
3. Построить управление сессиями WhatsApp-коннектора и медиапрокси.
4. Расширить фронтенд Next.js панелями тенантов и административными инструментами.
5. Усилить наблюдаемость, алертинг и подготовку релизов для пилотного запуска.
